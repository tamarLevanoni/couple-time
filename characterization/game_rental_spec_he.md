# אפיון מערכת השאלת משחקי זוגיות - גרסה מעודכנת

## 1. מבוא כללי

### 1.1 מטרת המערכת
מערכת ניהול השאלת משחקים עבור רשת מוקדים קהילתיים, עם דגש על:
- **חוויית משתמש פשוטה** - כל משתמש רואה רק מה שרלוונטי לתפקידו
- **ניהול מבוזר** - כל מוקד מנהל את המלאי שלו עצמאית
- **מעקב מרכזי** - מנהלי מערכת רואים תמונה כוללת

### 1.2 קהל יעד
- **שואלים** - משתמשי קצה המשאילים משחקים
- **רכזי מוקדים** - מנהלים השאלות במוקד ספציפי + יכולים להשאיל ממוקדים אחרים
- **רכזי על** - מסייעים לרכזי מוקדים + יכולים להשאיל ממוקדים אחרים
- **מנהלי מערכת** - אחראים על ניהול כולל + יכולים לכהן כרכזי מוקד + יכולים להשאיל

### 1.3 טכנולוגיות
- **Frontend**: Next.js עם React
- **Backend**: Next.js API Routes
- **Database**: PostgreSQL עם Prisma ORM
- **Authentication**: Google OAuth + Email/Password
- **Architecture**: Component-based, modular
- **Language**: Hebrew (RTL), English fallback

---

## 2. מבנה נתונים עיקרי

### 2.1 ישויות מרכזיות
```
User (משתמש)
├── id, name, email, phone
├── roles: ['USER', 'CENTER_COORDINATOR', 'SUPER_COORDINATOR', 'ADMIN']
├── managedCenterIds[] (מוקדים שהוא מנהל כרכז)
├── supervisedCenterIds[] (מוקדים שהוא מפקח עליהם כרכז-על)
└── isActive: boolean

Center (מוקד)
├── id, name, city, area
├── coordinatorId (רכז מוקד)
├── superCoordinatorId (רכז-על)
├── coordinates (למפה)
└── isActive: boolean

Game (משחק - גלובלי)
├── id, name, description, categories
├── targetAudiences: 'SINGLES' | 'MARRIED' | 'GENERAL'
└── imageUrl

GameInstance (עותק משחק במוקד)
├── gameId, centerId
├── status: 'AVAILABLE' | 'BORROWED' | 'UNAVAILABLE'
└── expectedReturnDate

Rental (השאלה)
├── userId, gameInstanceId
├── status: 'PENDING' | 'ACTIVE' | 'RETURNED' | 'CANCELLED'
├── requestDate, approvedDate, borrowDate, returnDate
└── expectedReturnDate
```

### 2.2 סטטוסי השאלה
1. **PENDING** - בקשה ממתינה לאישור רכז
3. **ACTIVE** - משחק נלקח ופעיל
4. **RETURNED** - הוחזר במועד
5. **CANCELLED** - בוטלה בזמן המתנה

---

## 3. מסכים ופונקציונליות

### 3.1 Header דינמי (קבוע בכל מסך)
```
┌─ לוגו ─┬─ ניווט ─┬─ אזור משתמש ─┐
│        │ בית     │              │
│        │ משחקים  │ [לא מחובר]   │
│        │ מוקדים  │ התחברות      │
│        │         │              │
│        │         │ [מחובר]      │
│        │         │ שם המשתמש ▼  │
└────────┴─────────┴──────────────┘
```

**ניווט משתנה לפי הרשאות:**
- **משתמש רגיל**: בית, משחקים, מוקדים
- **רכז מוקד**: + דשבורד רכז, ניהול השאלות המוקד שלי
- **רכז-על**: + דשבורד רכז-על, ניהול מוקדים מפוקחים
- **אדמין**: + דשבורד אדמין, ניהול מערכת

**הערה חשובה**: כל משתמש עם הרשאות ניהול (רכז/רכז-על/אדמין) יכול גם להשאיל כמשתמש רגיל מכל מוקד

### 3.2 דף הבית
**מטרה**: נקודת כניסה ראשית למערכת

**רכיבים:**
- Hero section עם קריאה לפעולה
- כפתורים מהירים: "חפש משחקים", "מצא מוקד", "השאל עכשיו"
- מידע על המערכת
- צור קשר
- Footer עם קישורים חברתיים

### 3.3 קטלוג משחקים
**מטרה**: חיפוש ובחירת משחקים לפי מוקד

**פילטרים:**
- בחירת מוקד (חובה)
- קטגוריה: רווקים/נשואים/כללי
- זמינות: זמין/מושאל/לא זמין

**תצוגת משחק:**
```
┌─────────────────────────────────┐
│ [תמונה]  שם המשחק             │
│          תיאור קצר             │
│          🟢 זמין / 🔴 מושאל    │
│          [לפרטים] [השאל עכשיו] │
└─────────────────────────────────┘
```

### 3.4 עמוד משחק
**מטרה**: פרטים מלאים + בקשת השאלה

**רכיבים:**
- תמונה גדולה ותיאור מפורט
- בחירת מוקד (Dropdown)
- סטטוס זמינות דינמי לפי מוקד
- כפתור "בקש להשאיל"

### 3.5 מפת מוקדים
**מטרה**: מציאת מוקד קרוב ומעבר למשחקים

**רכיבים:**
- מפה אינטראקטיבית עם סמנים
- רשימת מוקדים עם פרטי יצירת קשר
- חיפוש לפי אזור/עיר
- כפתור מעבר לקטלוג עבור כל מוקד

### 3.6 טופס השאלה
**מטרה**: יצירת בקשת השאלה

**זרימה:**
1. **אם מחובר**: רק בחירת מוקד ומשחק
2. **אם לא מחובר**: גם מילוי פרטים אישיים + הרשמה אוטומטית

**שדות:**
- מוקד (Dropdown)
- משחק (Dropdown או מוגדר מראש)
- אם לא מחובר: שם, טלפון, מייל

**לאחר שליחה:**
- יצירת השאלה במצב PENDING
- שליחת התראה לרכז (מייל + WhatsApp)
- הצגת הודעת אישור למשתמש

---

## 4. אזורי ניהול

### 4.1 אזור משתמש רגיל
**כרטיסיות:**
1. **פרטים אישיים**: עריכת שם וטלפון (מייל read-only)
2. **השאלות שלי**: טבלת היסטוריה עם אפשרות ביטול
3. **משובים שלי**: טבלת משובים שמילאתי (עתידי)


### 4.2 דשבורד רכז מוקד
**מטרה**: ניהול השאלות במוקד/ים שאני מנהל

**כרטיסיות:**
1. **בקשות ממתינות** (במוקד שלי)
   - טבלה: שם, תאריך, משחק
   - פעולות: אישור/דחיה/הרחבה

2. **השאלות פעילות** (במוקד שלי)
   - טבלה: שם, תאריך השאלה, משחק
   - פעולות: תזכורת/סימון החזרה/הרחבה

3. **החזרות** (במוקד שלי)
   - טבלה: שם, תאריך החזרה, משחק
   - פעולה: הרחבה

4. **ניהול מלאי** (המוקד שלי)
   - טבלת זמינות משחקים במוקד
   - עדכון סטטוסים ידני

5. **הוספת השאלה** (עבור המוקד שלי)
   - חיפוש משתמש קיים או יצירת חדש
   - יצירת השאלה מיידית

6. **פרטי המוקד שלי**
   - הצגת פרטי הרכז-על שלי
   - פרטי המוקד (שם, אזור, וכו')
   - סטטיסטיקות בסיסיות

**פופאפ הרחבה:**
- עריכת כל פרטי השאלה (תאריכים, הערות)
- היסטוריית שינויים

### 4.3 דשבורד רכז-על
**מטרה**: פיקוח ועזרה לרכזי המוקדים שאני מפקח עליהם

**כרטיסיות:**
1. **סקירת מוקדים מפוקחים**
   - רשימת המוקדים שלי
   - סטטוס כל מוקד (השאלות פתוחות, איחורים, וכו')
   - קישור מהיר לניהול כל מוקד

2. **השאלות ממתינות** (בכל המוקדים שלי)
   - טבלה עם עמודת מוקד נוספת
   - יכולת לטפל בבקשות במקום הרכז

3. **דוח איחורים** (במוקדים שלי)
   - רשימת השאלות באיחור
   - כלים לתזכורות ומעקב

4. **ניהול רכזים**
   - רשימת הרכזים שאני מפקח עליהם
   - יכולת להחליף רכז או לעזור בניהול

5. **משימות שלי** (עתידי)
   - רשימת משימות ספציפיות מהמנהלים
   - מעקב אחרי יעדים

**הערה**: רכז-על יכול להיכנס לכל מוקד שהוא מפקח עליו ולפעול כרכז מוקד

### 4.4 דשבורד אדמין
**מטרה**: ניהול כולל של המערכת + יכולת לפעול כרכז מוקד (אם משויך)

**כרטיסיות:**
1. **ניהול משתמשים**
   - טבלה: שם, מייל, תפקידים, מוקדים משויכים, סטטוס
   - עריכת הרשאות, שיוך למוקדים, חסימה/שחרור
   - הוספת רכזים ורכזי-על

2. **ניהול מוקדים**
   - הוספה/עריכה של מוקדים
   - שיוך רכזים ורכזי-על למוקדים
   - העברת מוקדים בין רכזים

3. **ניהול משחקים**
   - קטלוג גלובלי של משחקים
   - הוספה/עריכה/הסרה
   - שיוך למוקדים (bulk operations)

4. **דוחות וסטטיסטיקות**
   - פילטר לפי מוקד/רכז/תאריכים
   - מדדים: השאלות, החזרות, איחורים, פעילות רכזים
   - ייצוא CSV לכל דוח

5. **ניהול מערכת**
   - הגדרות כלליות
   - תבניות הודעות
   - לוגים ומעקב פעילות

6. **האזור שלי כרכז** (אם משויך למוקד)
   - מעבר מהיר לדשבורד רכז עבור המוקד שלי
   - כל הפונקציונליות של רכז מוקד רגיל

**הערה**: אדמין יכול לצפות ולנהל השאלות בכל מוקד, לא רק שלו

---

## 5. התראות ותקשורת

### 5.1 התראות אוטומטיות
- **בקשה חדשה** → רכז (מייל + WhatsApp)
- **אישור השאלה** → שואל (מייל + WhatsApp)
- **תזכורת החזרה** → שואל (לפני המועד + לאחר איחור)
- **דחיית בקשה** → שואל (מייל)

### 5.2 תבניות הודעות
```
WhatsApp לשואל בעת אישור:
"שלום [שם], השאלת המשחק '[שם משחק]' אושרה! 
ניתן לקחת במוקד [שם מוקד] אצל [שם רכז]: [טלפון]
תודה!"

מייל לרכז בעת בקשה:
"בקשת השאלה חדשה ממתינה לאישור
משחק: [שם]
שואל: [שם] - [טלפון]
[קישור לניהול]"
```

---

## 6. אבטחה ותכנות

### 6.1 הרשאות (מבוסס על roles array)
- **Guest**: צפייה בקטלוג ומוקדים
- **USER**: + יצירת בקשות השאלה
- **CENTER_COORDINATOR**: + ניהול השאלות במוקד/ים שמנהל + השאלה ממוקדים אחרים
- **SUPER_COORDINATOR**: + פיקוח על מספר מוקדים + עזרה לרכזים + השאלה ממוקדים אחרים
- **ADMIN**: + ניהול כולל של המערכת + יכולת לפעול כרכז + השאלה ממוקדים אחרים

**הערות חשובות:**
- משתמש יכול להיות בעל מספר תפקידים (למשל: USER + CENTER_COORDINATOR + ADMIN)
- רכז יכול לנהל מספר מוקדים
- רכז-על יכול לפקח על מספר מוקדים
- אדמין יכול להיות גם רכז של מוקד ספציפי
- כולם יכולים להשאיל כמשתמשים רגילים מכל מוקד

### 6.2 אבטחת נתונים
- Session management עם JWT
- הגנה על נתונים אישיים (GDPR compliant)
- Audit log לפעולות רגישות

---

## 7. שלבי פיתוח מוצעים

### 7.1 שלב 1 - MVP
- [ ] מבנה נתונים בסיסי (Prisma schema)
- [ ] Authentication
- [ ] קטלוג משחקים עם זמינות
- [ ] טופס השאלה בסיסי
- [ ] דשבורד רכז פשוט

### 7.2 שלב 2 - פונקציונליות מלאה
- [ ] מפת מוקדים
- [ ] התראות אוטומטיות
- [ ] דשבורד אדמין
- [ ] דוחות וסטטיסטיקות

### 7.3 שלב 3 - שיפורים
- [ ] אפליקציה מובילה (PWA)
- [ ] מערכת משובים
- [ ] התראות Push
- [ ] אינטגרציה עם לוח שנה

---

## 8. נקודות לבירור ושיפור

### 8.1 שאלות פתוחות
1. **ניהול מלאי**: מה קורה כשיש סתירה בין נתוני השאלות לזמינות?
2. **גמישות רכז**: כמה חופש לתת לרכז לעדכן תאריכים ללא מגבלות?
3. **משחקים פופולריים**: האם להוסיף מערכת המתנה או הזמנה מראש?
6. **משימות רכז-על**: איזה סוג משימות יקבל רכז-על מהאדמינים?
7. **דשבורד משולב**: האם רכז שהוא גם אדמין יראה הכל במקום אחד או בנפרד?

### 8.2 תכונות עתידיות אפשריות
- מערכת דירוגים ומשובים מפורטת
- התראות חכמות בהתאם להעדפות
- אינטגרציה עם מערכות תשלום
- ניהול מלאי אוטומטי עם ברקודים
- **מערכת משימות לרכזי-על** - הקצאת משימות ומעקב ביצוע
- **דוחות מתקדמים** - השוואות ביצועים בין מוקדים וזיהוי מגמות
- **אפליקציה נייד** עם התראות push לרכזים